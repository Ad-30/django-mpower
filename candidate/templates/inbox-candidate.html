{% extends 'candidate-index.html' %}
{% load static %}

{% block title %}
<title>mpower - Candidate dashboard - Inbox</title>
{% endblock %}

{% block content %}
<div class="pxp-dashboard-content-details">
    <h1>Inbox</h1>
    <p class="pxp-text-light">Keep in touch with companies.</p>

    <div class="row mt-4 mt-lg-5">
        <div class="col-xxl-4">
            <div class="pxp-dashboard-inbox-search-form">
                <div class="input-group">
                    <span class="input-group-text"><span class="fa fa-search"></span></span>
                    <input type="text" class="form-control" placeholder="Search messages...">
                </div>
            </div>

            <div class="mt-3 mt-lg-4 pxp-dashboard-inbox-list">
                <ul class="list-unstyled">
                    {% for i in threads %}
                    <li onclick="caller({{ i.msg_id }}, {{ mess }}, {{ thre }})">
                        <a href="#" class="pxp-dashboard-inbox-list-item">
                            <div class="pxp-dashboard-inbox-list-item-top">
                                <div class="pxp-dashboard-inbox-list-item-left">
                                    <div class="pxp-dashboard-inbox-list-item-avatar pxp-cover" style="background-image: url({% static 'images/company-logo-1.png' %});"></div>
                                    <div class="pxp-dashboard-inbox-list-item-name ms-2">{{ i.msg_id }}</div>
                                </div>
                                <div class="pxp-dashboard-inbox-list-item-right">
                                    <div class="pxp-dashboard-inbox-list-item-time">13:00</div>
                                </div>
                            </div>
                            <div class="mt-2 d-flex justify-content-between">
                                <div class="pxp-dashboard-inbox-list-item-text pxp-text-light">Replacing meaningful content with placeholder text allows...</div>
                                <div class="pxp-dashboard-inbox-list-item-no ms-3"><span class="badge rounded-pill">3</span></div>
                            </div>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col-xxl-8" id="messages-shower">
            <div class="pxp-dashboard-inbox-messages-container">
                <div class="pxp-dashboard-inbox-messages-header">
                    <div class="pxp-dashboard-inbox-list-item-left">
                        <div class="pxp-dashboard-inbox-list-item-avatar pxp-cover" style="background-image: url({% static 'images/company-logo-2.png' %});"></div>
                        <div class="pxp-dashboard-inbox-list-item-name ms-2">{{ threads.0.msg_id }}</div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="pxp-dashboard-inbox-list-item-options">
                            <button title="Delete conversation"><span class="fa fa-trash-o"></span></button>
                        </div>
                        <button class="btn rounded-pill pxp-dashboard-inbox-messages-close-btn d-inline-block d-xxl-none"><span class="fa fa-angle-left"></span> Back</button>
                    </div>
                </div>
                <div class="pxp-dashboard-inbox-messages-content">
                    {% for i in m.0 %}
                    {% if i.receiver_user|stringformat:'s' != threads.0.receiver|stringformat:'s' %}
                    <div class="pxp-dashboard-inbox-messages-item">
                        <div class="row justify-content-end">
                            <div class="col-7">
                                <div class="pxp-dashboard-inbox-messages-item-header flex-row-reverse">
                                    <div class="pxp-dashboard-inbox-messages-item-avatar pxp-cover" style="background-image: url({% static 'images/company-logo-3.png' %});"></div>
                                    <div class="pxp-dashboard-inbox-messages-item-name me-2">{{ i.sender_user }}</div>
                                    <div class="pxp-dashboard-inbox-messages-item-time pxp-text-light me-3">{{ i.date }}</div>
                                </div>
                                <div class="pxp-dashboard-inbox-messages-item-message pxp-is-other mt-2">
                                    {{ i.body }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="pxp-dashboard-inbox-messages-item mt-4">
                        <div class="row">
                            <div class="col-7">
                                <div class="pxp-dashboard-inbox-messages-item-header">
                                    <div class="pxp-dashboard-inbox-messages-item-avatar pxp-cover" style="background-image: url({% static 'images/company-logo-4.png' %});"></div>
                                    <div class="pxp-dashboard-inbox-messages-item-name ms-2">{{ i.sender_user }}</div>
                                    <div class="pxp-dashboard-inbox-messages-item-time pxp-text-light ms-3">{{ i.date }}</div>
                                </div>
                                <div class="pxp-dashboard-inbox-messages-item-message pxp-is-self mt-2">
                                    {{ i.body }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                    <div class="pxp-dashboard-inbox-messages-footer">
                        <div class="pxp-dashboard-inbox-messages-footer-field">
                            <input type="text" class="form-control" placeholder="Type your message here..." name="message">
                            <input type="text" class="form-control" placeholder="Type your message here..." name="employer" style="display: none" value={{ threads.0.msg_id }}>
                        </div>
                        <div class="pxp-dashboard-inbox-messages-footer-btn">
                            <button class="btn rounded-pill pxp-section-cta" id="sender1">Send</button>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
$(document).ready(function () {
    $('#das').removeClass('pxp-active');
    $('#edi').removeClass('pxp-active');
    $('#app').removeClass('pxp-active');
    $('#fav').removeClass('pxp-active');
    $('#cha').removeClass('pxp-active');
    $('#inb').addClass('pxp-active');
    $('#not').removeClass('pxp-active');
    $('.pxp-dashboard-inbox-messages-content').scrollTop($('.pxp-dashboard-inbox-messages-content')[0].scrollHeight);
    $('#sender1').click(function(e){
        e.preventDefault();
        $.ajax(
        {
            type:"POST",
            url: "sendfrom/",
            data:{
                    employer: $('[name="employer"]').val(),
                    message: $('[name="message"]').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function( data ) 
            {
                caller(data['id'], data['m'], data['thre'])
            }
         })
    })
    setInterval(mesRec, 10000);
    function mesRec()
    {
    $.ajax(
    {
        type:"GET",
        url: "fetchmess/",
        data:{
                employer: $('[name="employer"]').val()
        },
        success: function( data ) 
        {
            $.ajax(
            {
                type:"POST",
                url: "seenmes/",
                data:{
                        employer: $('[name="employer"]').val(),
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function( data ) 
                {
                    console.log("whre")
                },
                async: false
            })
            let mes=data['messa'];
            let thre=data['thread']
            let ms=JSON.parse(mes);
            let tempele=$('.pxp-dashboard-inbox-messages-content');
            let flag=0;
            for(let i=0;i<ms.length;i++)
            {
                if(ms[i])
                {
                if(ms[i].receiver_user_id!= JSON.parse(thre)[0].receiver_id)
                {
                    let itemdiv=document.createElement('div');
                    itemdiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item')
                    let rowdiv=document.createElement('div');
                    rowdiv.setAttribute('class', 'row justify-content-end')
                    let coldiv=document.createElement('div');
                    coldiv.setAttribute('class', 'col-7')
                    let ithediv=document.createElement('div');
                    ithediv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-header flex-row-reverse')
                    let firindiv=document.createElement('div');
                    firindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-avatar pxp-cover')
                    firindiv.style.backgroundImage='url({% static 'images/company-logo-2.png' %})';
                    let secindiv=document.createElement('div');
                    secindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-name me-2')
                    secindiv.innerHTML=ms[i].sender_user_id
                    let thiindiv=document.createElement('div');
                    thiindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-time pxp-text-light me-3')
                    thiindiv.innerHTML=ms[i].date
                    ithediv.append(firindiv);
                    ithediv.append(secindiv);
                    ithediv.append(thiindiv);
                    let indiv=document.createElement('div');
                    indiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-message pxp-is-other mt-2')
                    indiv.innerHTML=ms[i].body
                    coldiv.append(ithediv);
                    coldiv.append(indiv);
                    rowdiv.append(coldiv);
                    itemdiv.append(rowdiv);
                    tempele.append(itemdiv)
                }
                else
                {
                    let itemdiv=document.createElement('div');
                    itemdiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item mt-4')
                    let rowdiv=document.createElement('div');
                    rowdiv.setAttribute('class', 'row')
                    let coldiv=document.createElement('div');
                    coldiv.setAttribute('class', 'col-7')
                    let ithediv=document.createElement('div');
                    ithediv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-header')
                    let firindiv=document.createElement('div');
                    firindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-avatar pxp-cover')
                    firindiv.style.backgroundImage='url({% static 'images/company-logo-2.png' %})';
                    let secindiv=document.createElement('div');
                    secindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-name ms-2')
                    secindiv.innerHTML=ms[i].sender_user_id
                    let thiindiv=document.createElement('div');
                    thiindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-time pxp-text-light ms-3')
                    thiindiv.innerHTML=ms[i].date
                    ithediv.append(firindiv);
                    ithediv.append(secindiv);
                    ithediv.append(thiindiv);
                    let indiv=document.createElement('div');
                    indiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-message pxp-is-self mt-2')
                    indiv.innerHTML=ms[i].body
                    coldiv.append(ithediv);
                    coldiv.append(indiv);
                    rowdiv.append(coldiv);
                    itemdiv.append(rowdiv);
                    tempele.append(itemdiv)
                }
            }
            }
        },
        async: false
     })
    }
})
function caller(id, mess, thre1)
{
    $.ajax(
    {
        type:"POST",
        url: "seenmes/",
        data:{
                employer: $('[name="employer"]').val(),
                csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function( data ) 
        {
            console.log("Done")
        }, 
        async: false
     })
     let th=thre1;
     let mes=mess;
     let ms=[];
     let thre;
     $.ajax(
    {
        type:"GET",
        url: "fetchmess/",
        data:{
                employer: $('[name="employer"]').val()
        },
        success: function( data ) 
        {
            th=data['thre'];
            mes=data['all_mess'];
        },
        async: false
    })
    for(let j=0;j<JSON.parse(th[0]).length;j++)
    {
        if(JSON.parse(th[0])[j].msg_id==id)
        {
            thre=JSON.parse(th[0])[j]
        }
    }
    for (let i = 0; i < mes.length; i++) {
        if(JSON.parse(mes[i])[0])
        {
            if(JSON.parse(mes[i])[0].msg_id_id==id)
            {
            ms=JSON.parse(mes[i]);
            }
        }
    }
    $('.pxp-dashboard-inbox-messages-container').remove();

let headerdiv=document.createElement('div');
headerdiv.setAttribute('class', 'pxp-dashboard-inbox-messages-header');
let photodiv=document.createElement('div');
photodiv.setAttribute('class', 'pxp-dashboard-inbox-list-item-left');
let avatardiv=document.createElement('div');
avatardiv.setAttribute('class', 'pxp-dashboard-inbox-list-item-avatar pxp-cover');
avatardiv.style.backgroundImage='url({% static 'images/company-logo-2.png' %})';
let namediv=document.createElement('div');
namediv.setAttribute('class', 'pxp-dashboard-inbox-list-item-name ms-2');
namediv.innerHTML=id;
photodiv.append(avatardiv);
photodiv.append(namediv);
let deleterdiv=document.createElement('div');
deleterdiv.setAttribute('class', 'd-flex align-items-center');
let icondiv=document.createElement('div');
icondiv.setAttribute('class', 'pxp-dashboard-inbox-list-item-options');
let iconbutton=document.createElement('button');
iconbutton.setAttribute('title', 'Delete conversation');
let spandiv=document.createElement('span');
spandiv.setAttribute('class', 'fa fa-trash-o');
iconbutton.append(spandiv);
icondiv.append(iconbutton);
let backbutton=document.createElement('button');
backbutton.setAttribute('class', 'btn rounded-pill pxp-dashboard-inbox-messages-close-btn d-inline-block d-xxl-none');
let backspan=document.createElement('span');
backspan.setAttribute('class', 'fa fa-angle-left');
backspan.innerHTML=' Back'
backbutton.append(backspan);
deleterdiv.append(icondiv)
deleterdiv.append(backbutton);
headerdiv.append(photodiv);
headerdiv.append(deleterdiv);


let topdiv=document.createElement('div');
topdiv.setAttribute('class', 'pxp-dashboard-inbox-messages-container pxp-show');
topdiv.append(headerdiv);



let firstDiv=document.createElement('div')
firstDiv.setAttribute('class', 'pxp-dashboard-inbox-messages-content')
for(let i=0;i<ms.length;i++)
{
    if(ms[i].receiver_user_id != thre.receiver_id)
    {
        let itemdiv=document.createElement('div');
        itemdiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item')
        let rowdiv=document.createElement('div');
        rowdiv.setAttribute('class', 'row justify-content-end')
        let coldiv=document.createElement('div');
        coldiv.setAttribute('class', 'col-7')
        let ithediv=document.createElement('div');
        ithediv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-header flex-row-reverse')
        let firindiv=document.createElement('div');
        firindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-avatar pxp-cover')
        firindiv.style.backgroundImage='url({% static 'images/company-logo-2.png' %})';
        let secindiv=document.createElement('div');
        secindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-name me-2')
        secindiv.innerHTML=ms[i].sender_user_id
        let thiindiv=document.createElement('div');
        thiindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-time pxp-text-light me-3')
        thiindiv.innerHTML=ms[i].date
        ithediv.append(firindiv);
        ithediv.append(secindiv);
        ithediv.append(thiindiv);
        let indiv=document.createElement('div');
        indiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-message pxp-is-other mt-2')
        indiv.innerHTML=ms[i].body
        coldiv.append(ithediv);
        coldiv.append(indiv);
        rowdiv.append(coldiv);
        itemdiv.append(rowdiv);
        firstDiv.append(itemdiv)
    }
    else
    {
        let itemdiv=document.createElement('div');
        itemdiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item mt-4')
        let rowdiv=document.createElement('div');
        rowdiv.setAttribute('class', 'row')
        let coldiv=document.createElement('div');
        coldiv.setAttribute('class', 'col-7')
        let ithediv=document.createElement('div');
        ithediv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-header')
        let firindiv=document.createElement('div');
        firindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-avatar pxp-cover')
        firindiv.style.backgroundImage='url({% static 'images/company-logo-2.png' %})';
        let secindiv=document.createElement('div');
        secindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-name ms-2')
        secindiv.innerHTML=ms[i].sender_user_id
        let thiindiv=document.createElement('div');
        thiindiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-time pxp-text-light ms-3')
        thiindiv.innerHTML=ms[i].date
        ithediv.append(firindiv);
        ithediv.append(secindiv);
        ithediv.append(thiindiv);
        let indiv=document.createElement('div');
        indiv.setAttribute('class', 'pxp-dashboard-inbox-messages-item-message pxp-is-self mt-2')
        indiv.innerHTML=ms[i].body
        coldiv.append(ithediv);
        coldiv.append(indiv);
        rowdiv.append(coldiv);
        itemdiv.append(rowdiv);
        firstDiv.append(itemdiv)
    }
}

topdiv.append(firstDiv)


let form=document.createElement('form');
form.setAttribute('method', 'POST');
let footer=document.createElement('div');
footer.setAttribute('class', 'pxp-dashboard-inbox-messages-footer');
let field=document.createElement('div');
field.setAttribute('class', 'pxp-dashboard-inbox-messages-footer-field');
let inp1=document.createElement('input');
inp1.setAttribute('type', 'text');
inp1.setAttribute('class', 'form-control');
inp1.setAttribute('placeholder', 'Type your message here....');
inp1.setAttribute('name', 'message');
let inp2=document.createElement('input');
inp2.setAttribute('type', 'text');
inp2.setAttribute('class', 'form-control');
inp2.setAttribute('name', 'employer');
inp2.style.display='none';
inp2.setAttribute('value', id);
field.append(inp1);
field.append(inp2);
let fotbtn=document.createElement('div');
fotbtn.setAttribute('class', 'pxp-dashboard-inbox-messages-footer-btn');
let sendbtn=document.createElement('button');
sendbtn.setAttribute('id', 'sender');
sendbtn.setAttribute('class', 'btn rounded-pill pxp-section-cta');
sendbtn.innerHTML='Send';
fotbtn.append(sendbtn);
footer.append(field);
footer.append(fotbtn);
var csrf =document.createElement('input')
csrf.setAttribute('type','hidden');
csrf.setAttribute('value','{{ csrf_token }}');
form.append(csrf);
form.append(footer);
topdiv.append(footer);
$('#messages-shower').append(topdiv);
$('.pxp-dashboard-inbox-messages-content').scrollTop($('.pxp-dashboard-inbox-messages-content')[0].scrollHeight);
$('#sender').click(function(e){
    e.preventDefault();
    $.ajax(
    {
        type:"POST",
        url: "sendfrom/",
        data:{
                employer: $('[name="employer"]').val(),
                message: $('[name="message"]').val(),
                csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function( data ) 
        {
            caller(data['id'], data['m'], data['thre'])
        }
     })
})

$('.pxp-dashboard-inbox-messages-close-btn').click(function(e){
    $('.pxp-dashboard-inbox-messages-container').removeClass('pxp-show');
})
}


{% endblock %}

